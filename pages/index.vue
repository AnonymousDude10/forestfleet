<template>
  <div
    class="flex flex-col items-center justify-center gap-6 h-screen bg-gray-50 dark:bg-gray-900 overflow-hidden relative"
  >
    <div class="mb-2 z-10">
      <svg
        width="176"
        height="27"
        viewBox="0 0 176 27"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        class="text-gray-700 dark:text-gray-50"
      >
        <path
          d="M8.676 25.824H3.888V11.82H0V7.82399H3.888V6.92398C3.888 4.69198 4.488 3.01199 5.688 1.88399C6.888 0.755986 8.46 0.191986 10.404 0.191986C11.364 0.191986 12.552 0.299985 13.968 0.515985V4.90798C12.744 4.71598 11.832 4.61998 11.232 4.61998C10.296 4.61998 9.636 4.84798 9.252 5.30398C8.868 5.75998 8.676 6.46799 8.676 7.42798V7.82399H13.752V11.82H8.676V25.824Z"
          fill="currentColor"
        ></path>
        <path
          d="M14.1078 16.824C14.1078 14.976 14.5278 13.344 15.3678 11.928C16.2078 10.488 17.3598 9.37199 18.8238 8.57998C20.3118 7.78798 21.9678 7.39198 23.7918 7.39198C25.6158 7.39198 27.2598 7.78798 28.7238 8.57998C30.2118 9.37199 31.3758 10.488 32.2158 11.928C33.0558 13.344 33.4758 14.976 33.4758 16.824C33.4758 18.672 33.0558 20.316 32.2158 21.756C31.3758 23.172 30.2118 24.276 28.7238 25.068C27.2598 25.86 25.6158 26.256 23.7918 26.256C21.9678 26.256 20.3118 25.86 18.8238 25.068C17.3598 24.276 16.2078 23.172 15.3678 21.756C14.5278 20.316 14.1078 18.672 14.1078 16.824ZM28.5798 16.824C28.5798 15.408 28.1238 14.256 27.2118 13.368C26.2998 12.48 25.1598 12.036 23.7918 12.036C22.4238 12.036 21.2838 12.48 20.3718 13.368C19.4598 14.256 19.0038 15.408 19.0038 16.824C19.0038 18.24 19.4598 19.392 20.3718 20.28C21.2838 21.168 22.4238 21.612 23.7918 21.612C25.1598 21.612 26.2998 21.168 27.2118 20.28C28.1238 19.392 28.5798 18.24 28.5798 16.824Z"
          fill="currentColor"
        ></path>
        <path
          d="M41.1005 10.776C42.1565 8.51999 43.8605 7.39198 46.2125 7.39198C46.7165 7.39198 47.3045 7.47599 47.9765 7.64399V12.756C47.4005 12.564 46.6805 12.468 45.8165 12.468C44.2565 12.468 43.1045 12.9 42.3605 13.764C41.6405 14.628 41.2805 15.936 41.2805 17.688V25.824H36.5285V7.82399H41.1005V10.776Z"
          fill="currentColor"
        ></path>
        <path
          d="M48.6312 16.824C48.6312 15.048 49.0032 13.452 49.7472 12.036C50.5152 10.596 51.5952 9.46799 52.9872 8.65199C54.3792 7.81199 55.9992 7.39198 57.8472 7.39198C59.6712 7.39198 61.2432 7.78798 62.5632 8.57998C63.9072 9.37199 64.9392 10.488 65.6592 11.928C66.3792 13.368 66.7392 15.048 66.7392 16.968V18.264H53.4912L53.5272 18.336C53.7912 19.464 54.3792 20.328 55.2912 20.928C56.2032 21.504 57.2232 21.792 58.3512 21.792C60.3432 21.792 62.0472 21.18 63.4632 19.956L65.4432 23.88C63.5232 25.464 61.1352 26.256 58.2792 26.256C56.3112 26.256 54.5952 25.848 53.1312 25.032C51.6672 24.216 50.5512 23.1 49.7832 21.684C49.0152 20.244 48.6312 18.624 48.6312 16.824ZM61.5552 14.808C61.4352 13.8 61.0392 12.984 60.3672 12.36C59.7192 11.736 58.8312 11.424 57.7032 11.424C56.5752 11.424 55.6392 11.712 54.8952 12.288C54.1752 12.864 53.6952 13.704 53.4552 14.808H61.5552Z"
          fill="currentColor"
        ></path>
        <path
          d="M69.3543 13.116C69.3543 11.292 70.0263 9.88798 71.3703 8.90398C72.7143 7.89598 74.5743 7.39198 76.9503 7.39198C80.0223 7.39198 82.4103 8.27998 84.1143 10.056L81.4503 13.512C80.9223 12.936 80.2143 12.492 79.3263 12.18C78.4383 11.844 77.5143 11.676 76.5543 11.676C75.8343 11.676 75.2703 11.784 74.8623 12C74.4783 12.216 74.2863 12.528 74.2863 12.936C74.2863 13.224 74.3943 13.452 74.6103 13.62C74.8503 13.788 75.2223 13.944 75.7263 14.088C76.2303 14.208 77.1423 14.424 78.4623 14.736C80.3583 15.168 81.7863 15.804 82.7463 16.644C83.7303 17.46 84.2223 18.708 84.2223 20.388C84.2223 22.332 83.5503 23.796 82.2063 24.78C80.8863 25.764 78.9663 26.256 76.4463 26.256C74.6463 26.256 73.0503 26.004 71.6583 25.5C70.2903 24.972 69.2223 24.228 68.4543 23.268L71.2263 19.668C71.8503 20.388 72.6423 20.964 73.6023 21.396C74.5623 21.804 75.6783 22.008 76.9503 22.008C77.6703 22.008 78.2463 21.9 78.6783 21.684C79.1103 21.468 79.3263 21.12 79.3263 20.64C79.3263 20.328 79.2063 20.088 78.9663 19.92C78.7503 19.728 78.3903 19.56 77.8863 19.416C77.3823 19.272 76.5303 19.068 75.3303 18.804C73.5543 18.42 72.1143 17.808 71.0103 16.968C69.9063 16.128 69.3543 14.844 69.3543 13.116Z"
          fill="currentColor"
        ></path>
        <path
          d="M97.7777 25.464C96.2897 25.824 94.9937 26.004 93.8897 26.004C92.1617 26.004 90.8417 25.56 89.9297 24.672C89.0417 23.76 88.5977 22.308 88.5977 20.316V11.82H85.3217V7.82399H88.5977V2.99999H93.3497V7.82399H97.9217V11.82H93.3497V19.632C93.3497 20.208 93.4937 20.628 93.7817 20.892C94.0697 21.132 94.5257 21.252 95.1497 21.252C95.7497 21.252 96.6257 21.156 97.7777 20.964V25.464Z"
          fill="currentColor"
        ></path>
        <path
          d="M108.414 25.824H103.626V11.82H99.7383V7.82399H103.626V6.92398C103.626 4.69198 104.226 3.01199 105.426 1.88399C106.626 0.755986 108.198 0.191986 110.142 0.191986C111.102 0.191986 112.29 0.299985 113.706 0.515985V4.90798C112.482 4.71598 111.57 4.61998 110.97 4.61998C110.034 4.61998 109.374 4.84798 108.99 5.30398C108.606 5.75998 108.414 6.46799 108.414 7.42798V7.82399H113.49V11.82H108.414V25.824ZM121.122 25.824H116.334V0.623984H121.122V25.824Z"
          fill="#10B981"
        ></path>
        <path
          d="M124.147 16.824C124.147 15.048 124.519 13.452 125.263 12.036C126.031 10.596 127.111 9.46799 128.503 8.65199C129.895 7.81199 131.515 7.39198 133.363 7.39198C135.187 7.39198 136.759 7.78798 138.079 8.57998C139.423 9.37199 140.455 10.488 141.175 11.928C141.895 13.368 142.255 15.048 142.255 16.968V18.264H129.007L129.043 18.336C129.307 19.464 129.895 20.328 130.807 20.928C131.719 21.504 132.739 21.792 133.867 21.792C135.859 21.792 137.563 21.18 138.979 19.956L140.959 23.88C139.039 25.464 136.651 26.256 133.795 26.256C131.827 26.256 130.111 25.848 128.647 25.032C127.183 24.216 126.067 23.1 125.299 21.684C124.531 20.244 124.147 18.624 124.147 16.824ZM137.071 14.808C136.951 13.8 136.555 12.984 135.883 12.36C135.235 11.736 134.347 11.424 133.219 11.424C132.091 11.424 131.155 11.712 130.411 12.288C129.691 12.864 129.211 13.704 128.971 14.808H137.071Z"
          fill="#10B981"
        ></path>
        <path
          d="M144.186 16.824C144.186 15.048 144.558 13.452 145.302 12.036C146.07 10.596 147.15 9.46799 148.542 8.65199C149.934 7.81199 151.554 7.39198 153.402 7.39198C155.226 7.39198 156.798 7.78798 158.118 8.57998C159.462 9.37199 160.494 10.488 161.214 11.928C161.934 13.368 162.294 15.048 162.294 16.968V18.264H149.046L149.082 18.336C149.346 19.464 149.934 20.328 150.846 20.928C151.758 21.504 152.778 21.792 153.906 21.792C155.898 21.792 157.602 21.18 159.018 19.956L160.998 23.88C159.078 25.464 156.69 26.256 153.834 26.256C151.866 26.256 150.15 25.848 148.686 25.032C147.222 24.216 146.106 23.1 145.338 21.684C144.57 20.244 144.186 18.624 144.186 16.824ZM157.11 14.808C156.99 13.8 156.594 12.984 155.922 12.36C155.274 11.736 154.386 11.424 153.258 11.424C152.13 11.424 151.194 11.712 150.45 12.288C149.73 12.864 149.25 13.704 149.01 14.808H157.11Z"
          fill="#10B981"
        ></path>
        <path
          d="M175.543 25.464C174.055 25.824 172.759 26.004 171.655 26.004C169.927 26.004 168.607 25.56 167.695 24.672C166.807 23.76 166.363 22.308 166.363 20.316V11.82H163.087V7.82399H166.363V2.99999H171.115V7.82399H175.687V11.82H171.115V19.632C171.115 20.208 171.259 20.628 171.547 20.892C171.835 21.132 172.291 21.252 172.915 21.252C173.515 21.252 174.391 21.156 175.543 20.964V25.464Z"
          fill="#10B981"
        ></path>
      </svg>
    </div>

    <UCard class="w-full max-w-md z-10">
      <div class="flex flex-col items-center space-y-2 p-4">
        <h1 class="font-bold text-2xl text-primary">Welcome back!</h1>
        <p class="text-gray-500 dark:text-gray-400 text-sm">
          Please enter your credentials to access ForestFleet. If you do not
          have your credentials yet, please contact your Forest supervisor.
        </p>
      </div>

      <div class="p-4 space-y-6 w-full">
        <UForm :state="formState" @submit="handleLogin">
          <div class="space-y-4">
            <UFormGroup label="Email" name="email">
              <UInput
                v-model="formState.email"
                type="email"
                placeholder="Enter your email"
                autocomplete="email"
                class="w-full mb-2"
              />
            </UFormGroup>

            <UFormGroup label="Password" name="password">
              <UInput
                v-model="formState.password"
                type="password"
                placeholder="Enter your password"
                autocomplete="current-password"
                class="w-full mb-4"
              />
            </UFormGroup>

            <UButton type="submit" block :loading="loading" :disabled="loading">
              {{ loading ? "Signing in..." : "Sign in" }}
            </UButton>
          </div>
        </UForm>

        <USeparator label="Or continue with" />

        <div>
          <UButton
            block
            color="gray"
            variant="soft"
            icon="i-simple-icons-google"
            class="hover:cursor-pointer"
            @click="handleGoogleLogin"
          >
            Google
          </UButton>
        </div>
      </div>
    </UCard>

    <div class="absolute bottom-0 w-full h-1/2 z-0 overflow-hidden">
      <div
        class="absolute bottom-0 w-full transform-gpu"
        style="
          transform: perspective(1000px) rotateX(60deg);
          transform-origin: bottom;
        "
      >
        <div class="relative w-full h-screen">
          <div
            v-for="i in 20"
            :key="`h-${i}`"
            class="absolute w-full border-t border-primary-500/10 dark:border-primary-400/10"
            :style="{
              top: `${i * 5}%`,
              transform: `translateZ(${i * 2}px)`,
              opacity: 1 - i * 0.03,
            }"
          ></div>

          <div
            v-for="i in 20"
            :key="`v-${i}`"
            class="absolute h-full border-l border-primary-500/10 dark:border-primary-400/10"
            :style="{
              left: `${i * 5}%`,
              transform: `translateZ(${i * 2}px)`,
              opacity: 1 - i * 0.03,
            }"
          ></div>

          <div
            v-for="(circle, idx) in pulseCircles"
            :key="`circle-${idx}`"
            class="absolute rounded-full bg-primary-500/10 dark:bg-primary-400/10"
            :style="{
              width: `${circle.size}px`,
              height: `${circle.size}px`,
              left: `calc(${circle.x}% - ${circle.size / 2}px)`,
              top: `calc(${circle.y}% - ${circle.size / 2}px)`,
              transform: `translateZ(${circle.z}px)`,
              opacity: circle.opacity,
              animation: `pulse-${idx} ${circle.duration}s infinite`,
            }"
          ></div>
        </div>
      </div>

      <div
        class="absolute inset-0 bg-gradient-to-t from-gray-100/90 via-gray-100/40 to-transparent dark:from-gray-900/90 dark:via-gray-900/40 dark:to-transparent pointer-events-none"
      ></div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount } from "vue";
const toast = useToast();

const formState = ref({
  email: "",
  password: "",
});

const loading = ref(false);
const pulseCircles = ref([]);
let animationFrameId = null;

onMounted(() => {
  const token = localStorage.getItem("foresttoken");
  if (token) {
    navigateTo("/map");
  }
})

onMounted(() => {
  pulseCircles.value = Array(5)
    .fill()
    .map(() => createPulseCircle());

  const styleSheet = document.createElement("style");
  pulseCircles.value.forEach((circle, i) => {
    styleSheet.textContent += `
      @keyframes pulse-${i} {
        0% { opacity: ${circle.opacity}; transform: translateZ(${
      circle.z
    }px) scale(1); }
        50% { opacity: ${circle.opacity * 0.7}; transform: translateZ(${
      circle.z + 10
    }px) scale(1.2); }
        100% { opacity: ${circle.opacity}; transform: translateZ(${
      circle.z
    }px) scale(1); }
      }
    `;
  });
  document.head.appendChild(styleSheet);

  animateCircles();
});

onBeforeUnmount(() => {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
});

function createPulseCircle() {
  return {
    x: Math.random() * 100,
    y: Math.random() * 100,
    z: Math.random() * 50,
    size: 50 + Math.random() * 150,
    opacity: 0.05 + Math.random() * 0.1,
    duration: 3 + Math.random() * 7,
  };
}

function animateCircles() {
  pulseCircles.value.forEach((circle) => {
    circle.x += (Math.random() - 0.5) * 0.1;
    circle.y += (Math.random() - 0.5) * 0.1;

    if (circle.x < 0) circle.x = 0;
    if (circle.x > 100) circle.x = 100;
    if (circle.y < 0) circle.y = 0;
    if (circle.y > 100) circle.y = 100;
  });

  animationFrameId = requestAnimationFrame(animateCircles);
}

const handleLogin = async () => {
  try {
    loading.value = true;

    const response = await fetch("/api/auth/login", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email: formState.value.email,
        password: formState.value.password,
      }),
    });

    const data = await response.json();

    if (response.status !== 200) {
      throw new Error(data?.message || "Unexpected error occurred");
    }

    localStorage.setItem("foresttoken", data.token);

    navigateTo("/map");
  } catch (error) {
    toast.add({
      title: "Error",
      description: error.message,
      color: "red",
    });
  } finally {
    loading.value = false;
  }
};

const handleGoogleLogin = () => {
  loading.value = true;
  navigateTo("/api/auth/google");
};
</script>
